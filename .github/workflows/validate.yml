# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax
name: Validate

on:  # https://docs.github.com/en/actions/reference/workflows-and-actions/events-that-trigger-workflows
  push:
    branches-ignore:  # build all branches except:
    - 'dependabot/**'  # prevent workflow being triggered twice (once for commit to the branch and once for opening/syncing the PR)
    tags-ignore:  # don't build tags
    - '**'
    paths-ignore:
    - '**/*.md'
    - '.editorconfig'
    - '.git*'
  pull_request:
    paths-ignore:
    - '**/*.md'
    - '.editorconfig'
    - '.git*'

defaults:
  run:
    shell: bash


jobs:
  event_file:
    name: "Event File"
    runs-on: ubuntu-latest
    steps:
    - name: Upload
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: Event File
        path: ${{ github.event_path }}

  ###########################################################
  build:
  ###########################################################

    strategy:
      fail-fast: false
      matrix:
        os:  # https://github.com/actions/runner-images#available-images
        - ubuntu-latest
        - macos-15-intel # Intel
        - macos-latest # ARM
        - windows-latest
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20

    steps:

    - name: Git Checkout
      uses: actions/checkout@v6  # https://github.com/actions/checkout


    - name: "Install: JDKs for building and testing"
      uses: actions/setup-java@v5  # https://github.com/actions/setup-java
      with:
        distribution: temurin
        java-version: |
          11
          17
          21
        cache: gradle

    - name: Build with Gradle üèóÔ∏è
      run: ./gradlew build jmhCompileGeneratedClasses testOlderJavas

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: Test Results ${{ matrix.os }}
        if-no-files-found: warn
        path: |
          ${{ github.workspace }}/**/build/test-results/**/*.xml
          ${{ github.workspace }}/**/build/reports/


    - name: Run API Compare
      if: ${{ matrix.os == 'ubuntu-latest' }}
      run: ./releng/runjapicmp.sh

    - name: Upload API Compare results
      if: ${{ matrix.os == 'ubuntu-latest' }}
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: API Compare results
        if-no-files-found: warn
        path: |
          ${{ github.workspace }}/build/p2-repository/japicmp-report/
